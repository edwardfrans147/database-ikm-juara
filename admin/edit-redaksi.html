<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Redaksi Website - Database IKM JUARA</title>
    <link rel="stylesheet" href="/shared/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .content-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .content-item {
            border: 1px solid #ecf0f1;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .content-item:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .content-item h4 {
            color: #27ae60;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .edit-form {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .add-content-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .add-content-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .add-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px dashed #27ae60;
            display: none;
        }
        
        .add-form.active {
            display: block;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-grid.full-width {
            grid-template-columns: 1fr;
        }
        
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(39, 174, 96, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 2s infinite;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-industry" style="font-size: 24px;"></i>
            <h3 style="margin-top: 10px;">IKM JUARA</h3>
            <p style="font-size: 12px; margin-top: 5px;">DisnakerKUKM Kota Madiun</p>
        </div>
        
        <nav>
            <a href="index.html" class="menu-item">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </a>
            
            <a href="ikm-binaan.html" class="menu-item">
                <i class="fas fa-building"></i>
                IKM Binaan
            </a>
            
            <a href="inputan-layanan.html" class="menu-item">
                <i class="fas fa-plus-circle"></i>
                Inputan Layanan IKM
            </a>
            
            <a href="layanan-ikm.html" class="menu-item">
                <i class="fas fa-clipboard-list"></i>
                Layanan IKM Juara
            </a>
            
            <a href="pelatihan.html" class="menu-item">
                <i class="fas fa-graduation-cap"></i>
                Pelatihan Pemberdayaan
            </a>
            
            <a href="penelusuran.html" class="menu-item">
                <i class="fas fa-search"></i>
                Penelusuran Data
            </a>
            
            <a href="edit-redaksi.html" class="menu-item active">
                <i class="fas fa-edit"></i>
                Edit Redaksi Website
            </a>
            
            <a href="activity-logs.html" class="menu-item">
                <i class="fas fa-history"></i>
                Activity Logs
            </a>
            
            <a href="recycle-bin.html" class="menu-item">
                <i class="fas fa-trash-restore"></i>
                Recycle Bin
            </a>
            
            <a href="/public" class="menu-item">
                <i class="fas fa-external-link-alt"></i>
                Website Publik
            </a>
            
            <a href="#" class="menu-item" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Sync Indicator -->
        <div class="sync-indicator">
            <div class="sync-dot"></div>
            <span>Tersinkron dengan Website Pengguna</span>
        </div>
        
        <div class="header">
            <h1>Edit Redaksi Website Pengguna</h1>
            <div class="user-info">
                <span id="user-name">Admin</span>
                <i class="fas fa-user-circle" style="margin-left: 10px; font-size: 24px;"></i>
            </div>
        </div>

        <!-- Layanan IKM Section -->
        <div class="content-section">
            <h3><i class="fas fa-clipboard-list"></i> Layanan IKM Juara</h3>
            <p style="color: #7f8c8d; margin-bottom: 20px;">Edit konten layanan yang ditampilkan di website pengguna</p>
            
            <button class="add-content-btn" onclick="toggleAddForm('layanan-ikm')">
                <i class="fas fa-plus"></i> Tambah Layanan Baru
            </button>
            
            <div class="add-form" id="add-form-layanan-ikm">
                <h4><i class="fas fa-plus-circle"></i> Tambah Layanan IKM Juara Baru</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nama Layanan</label>
                        <input type="text" class="form-control" id="new-layanan-title" placeholder="Contoh: Pendaftaran Sertifikat ISO">
                    </div>
                    <div class="form-group">
                        <label>Kontak yang Bisa Dihubungi</label>
                        <input type="text" class="form-control" id="new-layanan-contact" placeholder="Contoh: WhatsApp: 081234567890">
                    </div>
                </div>
                <div class="form-grid full-width">
                    <div class="form-group">
                        <label>Deskripsi Layanan</label>
                        <textarea class="form-control" id="new-layanan-description" rows="3" placeholder="Masukkan deskripsi lengkap layanan..."></textarea>
                    </div>
                </div>
                <div class="form-grid full-width">
                    <div class="form-group">
                        <label>Link Informasi/Pendaftaran (Opsional)</label>
                        <input type="url" class="form-control" id="new-layanan-link" placeholder="https://contoh.com/pendaftaran">
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="addNewContent('layanan-ikm')">
                        <i class="fas fa-save"></i> Simpan Layanan
                    </button>
                    <button class="btn btn-secondary" onclick="cancelAddForm('layanan-ikm')">
                        <i class="fas fa-times"></i> Batal
                    </button>
                </div>
            </div>
            
            <div id="layanan-content">
                <!-- Layanan content will be loaded here -->
            </div>
        </div>

        <!-- Pelatihan Section -->
        <div class="content-section">
            <h3><i class="fas fa-graduation-cap"></i> Program Pelatihan Pemberdayaan Industri</h3>
            <p style="color: #7f8c8d; margin-bottom: 20px;">Edit konten pelatihan yang ditampilkan di website pengguna</p>
            
            <button class="add-content-btn" onclick="toggleAddForm('pelatihan')">
                <i class="fas fa-plus"></i> Tambah Program Pelatihan Baru
            </button>
            
            <div class="add-form" id="add-form-pelatihan">
                <h4><i class="fas fa-plus-circle"></i> Tambah Program Pelatihan Baru</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nama Kegiatan Pelatihan</label>
                        <input type="text" class="form-control" id="new-pelatihan-title" placeholder="Contoh: Workshop Digital Marketing untuk IKM">
                    </div>
                    <div class="form-group">
                        <label>Kontak Pendaftaran/Informasi</label>
                        <input type="text" class="form-control" id="new-pelatihan-contact" placeholder="Contoh: Telp: (0351) 123456, WA: 081234567890">
                    </div>
                </div>
                <div class="form-grid full-width">
                    <div class="form-group">
                        <label>Deskripsi Kegiatan</label>
                        <textarea class="form-control" id="new-pelatihan-description" rows="3" placeholder="Masukkan deskripsi lengkap kegiatan pelatihan..."></textarea>
                    </div>
                </div>
                <div class="form-grid full-width">
                    <div class="form-group">
                        <label>Link Pendaftaran Pelatihan (Bisa Diklik)</label>
                        <input type="url" class="form-control" id="new-pelatihan-link" placeholder="https://contoh.com/daftar-pelatihan">
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="addNewContent('pelatihan')">
                        <i class="fas fa-save"></i> Simpan Program Pelatihan
                    </button>
                    <button class="btn btn-secondary" onclick="cancelAddForm('pelatihan')">
                        <i class="fas fa-times"></i> Batal
                    </button>
                </div>
            </div>
            
            <div id="pelatihan-content">
                <!-- Pelatihan content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Check authentication
        const adminUser = localStorage.getItem('admin_user');
        if (!adminUser) {
            window.location.href = 'login.html';
        } else {
            const user = JSON.parse(adminUser);
            document.getElementById('user-name').textContent = user.nama;
        }

        // Load website content
        const loadWebsiteContent = async () => {
            try {
                console.log('Loading website content...');
                const response = await fetch('/api/website-content');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Expected JSON but got:', contentType, text.substring(0, 200));
                    throw new Error('Server returned non-JSON response. Please check if server is running correctly.');
                }
                
                const data = await response.json();
                console.log('Loaded data:', data);
                
                // Load layanan content
                const layananSection = data.find(section => section.section === 'layanan-ikm');
                console.log('Layanan section:', layananSection);
                if (layananSection) {
                    renderLayananContent(layananSection.content);
                } else {
                    console.warn('Layanan section not found');
                    document.getElementById('layanan-content').innerHTML = '<p class="text-center text-muted">Bagian layanan tidak ditemukan</p>';
                }
                
                // Load pelatihan content
                const pelatihanSection = data.find(section => section.section === 'pelatihan');
                console.log('Pelatihan section:', pelatihanSection);
                if (pelatihanSection) {
                    renderPelatihanContent(pelatihanSection.content);
                } else {
                    console.warn('Pelatihan section not found');
                    document.getElementById('pelatihan-content').innerHTML = '<p class="text-center text-muted">Bagian pelatihan tidak ditemukan</p>';
                }
            } catch (error) {
                console.error('Failed to load website content:', error);
                showAlert('Gagal memuat konten website: ' + error.message, 'error');
                
                // Show fallback content
                document.getElementById('layanan-content').innerHTML = '<p class="text-center text-muted">Gagal memuat konten layanan</p>';
                document.getElementById('pelatihan-content').innerHTML = '<p class="text-center text-muted">Gagal memuat konten pelatihan</p>';
            }
        };

        // Render layanan content
        const renderLayananContent = (content) => {
            const container = document.getElementById('layanan-content');
            let html = '';
            
            content.forEach(item => {
                html += `
                    <div class="content-item">
                        <h4>
                            <span>${item.title}</span>
                            <div class="btn-group">
                                <button class="btn btn-warning btn-sm" onclick="editContent('layanan-ikm', '${item.id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteContent('layanan-ikm', '${item.id}')">
                                    <i class="fas fa-trash"></i> Hapus
                                </button>
                            </div>
                        </h4>
                        <p>${item.description}</p>
                        ${item.contact ? `<p><strong>Kontak:</strong> ${item.contact}</p>` : ''}
                        ${item.link ? `<p><strong>Link:</strong> <a href="${item.link}" target="_blank">${item.link}</a></p>` : ''}
                        
                        <div class="edit-form" id="edit-form-${item.id}">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Judul</label>
                                    <input type="text" class="form-control" id="title-${item.id}" value="${item.title}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Deskripsi</label>
                                    <textarea class="form-control" id="desc-${item.id}" rows="3">${item.description}</textarea>
                                </div>
                            </div>
                            ${item.contact !== undefined ? `
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Kontak</label>
                                    <input type="text" class="form-control" id="contact-${item.id}" value="${item.contact || ''}">
                                </div>
                            </div>
                            ` : ''}
                            ${item.link !== undefined ? `
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Link</label>
                                    <input type="url" class="form-control" id="link-${item.id}" value="${item.link || ''}">
                                </div>
                            </div>
                            ` : ''}
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="saveContent('layanan-ikm', '${item.id}')">
                                    <i class="fas fa-save"></i> Simpan
                                </button>
                                <button class="btn btn-secondary" onclick="cancelEdit('${item.id}')">
                                    <i class="fas fa-times"></i> Batal
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        };

        // Render pelatihan content
        const renderPelatihanContent = (content) => {
            const container = document.getElementById('pelatihan-content');
            let html = '';
            
            content.forEach(item => {
                html += `
                    <div class="content-item">
                        <h4>
                            <span>${item.title}</span>
                            <div class="btn-group">
                                <button class="btn btn-warning btn-sm" onclick="editContent('pelatihan', '${item.id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteContent('pelatihan', '${item.id}')">
                                    <i class="fas fa-trash"></i> Hapus
                                </button>
                            </div>
                        </h4>
                        <p>${item.description}</p>
                        ${item.contact ? `<p><strong>Kontak:</strong> ${item.contact}</p>` : ''}
                        ${item.link ? `<p><strong>Link Pendaftaran:</strong> <a href="${item.link}" target="_blank" class="link-button"><i class="fas fa-external-link-alt"></i> Daftar Sekarang</a></p>` : ''}
                        
                        <div class="edit-form" id="edit-form-${item.id}">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Judul</label>
                                    <input type="text" class="form-control" id="title-${item.id}" value="${item.title}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Deskripsi</label>
                                    <textarea class="form-control" id="desc-${item.id}" rows="3">${item.description}</textarea>
                                </div>
                            </div>
                            ${item.contact !== undefined ? `
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Kontak</label>
                                    <input type="text" class="form-control" id="contact-${item.id}" value="${item.contact || ''}">
                                </div>
                            </div>
                            ` : ''}
                            ${item.link !== undefined ? `
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Link Pendaftaran</label>
                                    <input type="url" class="form-control" id="link-${item.id}" value="${item.link || ''}">
                                </div>
                            </div>
                            ` : ''}
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="saveContent('pelatihan', '${item.id}')">
                                    <i class="fas fa-save"></i> Simpan
                                </button>
                                <button class="btn btn-secondary" onclick="cancelEdit('${item.id}')">
                                    <i class="fas fa-times"></i> Batal
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        };

        // Edit content
        const editContent = (section, itemId) => {
            // Hide all edit forms
            document.querySelectorAll('.edit-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // Show selected edit form
            const editForm = document.getElementById(`edit-form-${itemId}`);
            if (editForm) {
                editForm.style.display = 'block';
            }
        };

        // Cancel edit
        const cancelEdit = (itemId) => {
            const editForm = document.getElementById(`edit-form-${itemId}`);
            if (editForm) {
                editForm.style.display = 'none';
            }
        };

        // Save content
        const saveContent = async (section, itemId) => {
            const title = document.getElementById(`title-${itemId}`).value.trim();
            const description = document.getElementById(`desc-${itemId}`).value.trim();
            
            // Check if contact and link fields exist (for new content)
            const contactField = document.getElementById(`contact-${itemId}`);
            const linkField = document.getElementById(`link-${itemId}`);
            
            const contact = contactField ? contactField.value.trim() : undefined;
            const link = linkField ? linkField.value.trim() : undefined;
            
            if (!title || !description) {
                showAlert('Judul dan deskripsi tidak boleh kosong', 'error');
                return;
            }
            
            const requestBody = {
                section,
                itemId,
                title,
                description
            };
            
            // Only include contact and link if the fields exist
            if (contact !== undefined) requestBody.contact = contact;
            if (link !== undefined) requestBody.link = link;
            
            try {
                const response = await fetch('/api/website-content', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (response.ok) {
                    showAlert('Konten berhasil diperbarui', 'success');
                    cancelEdit(itemId);
                    loadWebsiteContent(); // Reload content
                    showSyncAnimation();
                } else {
                    const result = await response.json();
                    showAlert(result.error || 'Gagal memperbarui konten', 'error');
                }
            } catch (error) {
                console.error('Failed to save content:', error);
                showAlert('Terjadi kesalahan saat menyimpan konten', 'error');
            }
        };

        // Logout function
        const logout = () => {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                localStorage.removeItem('admin_user');
                window.location.href = 'login.html';
            }
        };

        // Toggle add form
        const toggleAddForm = (section) => {
            const form = document.getElementById(`add-form-${section}`);
            const isActive = form.classList.contains('active');
            
            // Hide all add forms
            document.querySelectorAll('.add-form').forEach(f => f.classList.remove('active'));
            
            if (!isActive) {
                form.classList.add('active');
                // Clear form
                form.querySelectorAll('input, textarea').forEach(input => input.value = '');
            }
        };

        // Cancel add form
        const cancelAddForm = (section) => {
            const form = document.getElementById(`add-form-${section}`);
            form.classList.remove('active');
            // Clear form
            form.querySelectorAll('input, textarea').forEach(input => input.value = '');
        };

        // Add new content
        const addNewContent = async (section) => {
            const titleId = `new-${section}-title`;
            const descId = `new-${section}-description`;
            const contactId = `new-${section}-contact`;
            const linkId = `new-${section}-link`;
            
            const title = document.getElementById(titleId).value.trim();
            const description = document.getElementById(descId).value.trim();
            const contact = document.getElementById(contactId).value.trim();
            const link = document.getElementById(linkId).value.trim();
            
            console.log('Adding new content:', { section, title, description, contact, link });
            
            if (!title || !description) {
                showAlert('Nama kegiatan dan deskripsi tidak boleh kosong', 'error');
                return;
            }
            
            try {
                const requestBody = {
                    section,
                    title,
                    description,
                    contact,
                    link
                };
                
                console.log('Request body:', requestBody);
                
                const response = await fetch('/api/website-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Success result:', result);
                    showAlert('Konten baru berhasil ditambahkan', 'success');
                    cancelAddForm(section);
                    loadWebsiteContent(); // Reload content
                    showSyncAnimation();
                } else {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const result = await response.json();
                        console.error('Error result:', result);
                        showAlert(result.error || 'Gagal menambahkan konten', 'error');
                    } else {
                        const text = await response.text();
                        console.error('Non-JSON error response:', text.substring(0, 200));
                        showAlert('Server error: Received non-JSON response. Please check if server is running correctly.', 'error');
                    }
                }
            } catch (error) {
                console.error('Failed to add content:', error);
                showAlert('Terjadi kesalahan saat menambahkan konten: ' + error.message, 'error');
            }
        };

        // Delete content
        const deleteContent = async (section, itemId) => {
            if (!confirm('Apakah Anda yakin ingin menghapus konten ini?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/website-content', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        section,
                        itemId
                    })
                });
                
                if (response.ok) {
                    showAlert('Konten berhasil dihapus', 'success');
                    loadWebsiteContent(); // Reload content
                    showSyncAnimation();
                } else {
                    const result = await response.json();
                    showAlert(result.error || 'Gagal menghapus konten', 'error');
                }
            } catch (error) {
                console.error('Failed to delete content:', error);
                showAlert('Terjadi kesalahan saat menghapus konten', 'error');
            }
        };

        // Show sync animation
        const showSyncAnimation = () => {
            const indicator = document.querySelector('.sync-indicator');
            indicator.style.animation = 'none';
            indicator.offsetHeight; // Trigger reflow
            indicator.style.animation = 'pulse 0.5s ease-in-out 3';
        };

        // Show alert function
        const showAlert = (message, type = 'info') => {
            // Create alert element
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 1001;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease-out;
            `;
            alert.textContent = message;
            
            // Add animation keyframes
            if (!document.getElementById('alert-styles')) {
                const style = document.createElement('style');
                style.id = 'alert-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(alert);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                alert.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }, 3000);
        };

        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadWebsiteContent);
    </script>
</body>
</html>