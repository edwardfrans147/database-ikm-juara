<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pelatihan Pemberdayaan - Database IKM JUARA</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .action-buttons .btn {
            white-space: nowrap;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .badge-success { background: #27ae60; color: white; }
        .badge-primary { background: #3498db; color: white; }
        .badge-danger { background: #e74c3c; color: white; }
        .badge-secondary { background: #7f8c8d; color: white; }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-industry" style="font-size: 24px;"></i>
            <h3 style="margin-top: 10px;">IKM JUARA</h3>
            <p style="font-size: 12px; margin-top: 5px;">DisnakerKUKM Kota Madiun</p>
        </div>
        
        <nav>
            <a href="index.html" class="menu-item">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </a>
            
            <a href="ikm-binaan.html" class="menu-item">
                <i class="fas fa-building"></i>
                IKM Binaan
            </a>
            
            <a href="inputan-layanan.html" class="menu-item">
                <i class="fas fa-plus-circle"></i>
                Inputan Layanan IKM
            </a>
            
            <a href="layanan-ikm.html" class="menu-item">
                <i class="fas fa-clipboard-list"></i>
                Layanan IKM Juara
            </a>
            
            <a href="pelatihan.html" class="menu-item active">
                <i class="fas fa-graduation-cap"></i>
                Pelatihan Pemberdayaan
            </a>
            
            <a href="penelusuran.html" class="menu-item">
                <i class="fas fa-search"></i>
                Penelusuran Data
            </a>
            
            <a href="recycle-bin.html" class="menu-item">
                <i class="fas fa-trash-restore"></i>
                Recycle Bin
            </a>
            
            <a href="/public" class="menu-item">
                <i class="fas fa-external-link-alt"></i>
                Website Publik
            </a>
            
            <a href="#" class="menu-item" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <h1>Pelatihan Pemberdayaan Industri</h1>
            <div class="user-info">
                <span id="user-name">Admin</span>
                <i class="fas fa-user-circle" style="margin-left: 10px; font-size: 24px;"></i>
            </div>
        </div>

        <!-- Content -->
        <div class="table-container">
            <div class="table-header">
                <h3>Daftar Program Pelatihan</h3>
                <div class="action-buttons">
                    <button class="btn btn-info" onclick="exportData('excel')">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button class="btn btn-warning" onclick="exportData('pdf')">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button class="btn btn-primary" onclick="showAddForm()">
                        <i class="fas fa-plus"></i> Tambah Pelatihan
                    </button>
                </div>
            </div>
            
            <div id="pelatihan-table">
                <!-- Table will be loaded here -->
            </div>
        </div>

        <!-- Add/Edit Form Modal -->
        <div id="form-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto;">
                <h3 id="form-title">Tambah Program Pelatihan</h3>
                <form id="pelatihan-form">
                    <div class="form-group">
                        <label>Judul Pelatihan *</label>
                        <input type="text" name="judulPelatihan" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Deskripsi *</label>
                        <textarea name="deskripsi" class="form-control" rows="3" required></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>Tanggal Mulai *</label>
                            <input type="date" name="tanggalMulai" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Tanggal Selesai *</label>
                            <input type="date" name="tanggalSelesai" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Lokasi *</label>
                        <input type="text" name="lokasi" class="form-control" required>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>Instruktur *</label>
                            <input type="text" name="instruktur" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Kuota Peserta *</label>
                            <input type="number" name="kuota" class="form-control" required min="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Status *</label>
                        <select name="status" class="form-control" required>
                            <option value="">Pilih Status</option>
                            <option value="Aktif">Aktif</option>
                            <option value="Selesai">Selesai</option>
                            <option value="Dibatalkan">Dibatalkan</option>
                        </select>
                    </div>
                    
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="hideForm()" style="margin-right: 10px;">Batal</button>
                        <button type="submit" class="btn btn-primary" id="submit-btn">Simpan</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Participants Management Modal -->
        <div id="participants-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 95%; max-width: 1000px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 id="participants-title">Kelola Peserta Pelatihan</h3>
                    <button class="btn btn-secondary" onclick="hideParticipantsModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="training-info" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <!-- Training info will be loaded here -->
                </div>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <input type="text" id="search-participant" class="form-control" placeholder="Cari peserta (NIB, NIK, atau Nama)">
                    </div>
                    <button class="btn btn-success" onclick="addParticipant()">
                        <i class="fas fa-user-plus"></i> Tambah Peserta
                    </button>
                    <button class="btn btn-info" onclick="exportParticipants('excel')">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button class="btn btn-warning" onclick="exportParticipants('pdf')">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                </div>
                
                <div id="participants-table">
                    <!-- Participants table will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="/script.js"></script>
    <script>
        let editingId = null;

        // Check authentication
        const adminUser = localStorage.getItem('admin_user');
        if (!adminUser) {
            window.location.href = 'login.html';
        } else {
            const user = JSON.parse(adminUser);
            document.getElementById('user-name').textContent = user.nama;
        }

        // Load pelatihan data
        const loadPelatihan = async () => {
            try {
                const data = await getData('pelatihan-pemberdayaan');
                const columns = [
                    { field: 'judulPelatihan', title: 'Judul Pelatihan' },
                    { 
                        field: 'tanggalMulai', 
                        title: 'Tanggal Mulai',
                        format: (date) => new Date(date).toLocaleDateString('id-ID')
                    },
                    { 
                        field: 'tanggalSelesai', 
                        title: 'Tanggal Selesai',
                        format: (date) => new Date(date).toLocaleDateString('id-ID')
                    },
                    { field: 'instruktur', title: 'Instruktur' },
                    { field: 'kuota', title: 'Kuota' },
                    { 
                        field: 'peserta', 
                        title: 'Peserta',
                        format: (peserta) => peserta ? peserta.length : 0
                    },
                    { 
                        field: 'status', 
                        title: 'Status',
                        format: (status) => {
                            const colors = {
                                'Aktif': 'success',
                                'Selesai': 'primary',
                                'Dibatalkan': 'danger'
                            };
                            const color = colors[status] || 'secondary';
                            return `<span class="badge badge-${color}">${status}</span>`;
                        }
                    }
                ];
                
                const actions = [
                    { text: 'Kelola Peserta', class: 'info', onclick: 'manageParticipants' },
                    { text: 'Edit', class: 'warning', onclick: 'editPelatihan' },
                    { text: 'Hapus', class: 'danger', onclick: 'deletePelatihan' }
                ];
                
                document.getElementById('pelatihan-table').innerHTML = createTable(data, columns, actions);
            } catch (error) {
                console.error('Failed to load pelatihan data:', error);
            }
        };

        // Export data function
        const exportData = (format) => {
            const url = `/api/export/pelatihan-pemberdayaan/${format}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = `Pelatihan_Pemberdayaan_${new Date().toISOString().split('T')[0]}.${format === 'excel' ? 'xlsx' : 'pdf'}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        let currentTrainingId = null;

        // Manage participants
        const manageParticipants = async (id) => {
            try {
                currentTrainingId = id;
                const training = await getDataById('pelatihan-pemberdayaan', id);
                
                document.getElementById('participants-title').textContent = `Kelola Peserta - ${training.judulPelatihan}`;
                
                // Show training info
                const trainingInfo = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div><strong>Judul:</strong> ${training.judulPelatihan}</div>
                        <div><strong>Tanggal:</strong> ${new Date(training.tanggalMulai).toLocaleDateString('id-ID')} - ${new Date(training.tanggalSelesai).toLocaleDateString('id-ID')}</div>
                        <div><strong>Lokasi:</strong> ${training.lokasi}</div>
                        <div><strong>Kuota:</strong> ${training.kuota}</div>
                        <div><strong>Peserta Terdaftar:</strong> ${training.peserta ? training.peserta.length : 0}</div>
                        <div><strong>Sisa Kuota:</strong> ${training.kuota - (training.peserta ? training.peserta.length : 0)}</div>
                    </div>
                `;
                document.getElementById('training-info').innerHTML = trainingInfo;
                
                loadParticipants();
                document.getElementById('participants-modal').style.display = 'block';
            } catch (error) {
                console.error('Failed to load training data:', error);
                showAlert('Gagal memuat data pelatihan', 'error');
            }
        };

        // Load participants
        const loadParticipants = async () => {
            try {
                const training = await getDataById('pelatihan-pemberdayaan', currentTrainingId);
                const participants = training.peserta || [];
                
                if (participants.length === 0) {
                    document.getElementById('participants-table').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Belum ada peserta terdaftar</p>';
                    return;
                }
                
                const columns = [
                    { field: 'nib', title: 'NIB' },
                    { field: 'nik', title: 'NIK' },
                    { field: 'namaLengkap', title: 'Nama Lengkap' },
                    { field: 'namaUsaha', title: 'Nama Usaha' },
                    { field: 'nomorHP', title: 'Nomor HP' },
                    { 
                        field: 'tanggalDaftar', 
                        title: 'Tanggal Daftar',
                        format: (date) => new Date(date).toLocaleDateString('id-ID')
                    }
                ];
                
                const actions = [
                    { text: 'Hapus', class: 'danger', onclick: 'removeParticipant' }
                ];
                
                // Create custom table for participants
                let html = '<table><thead><tr>';
                html += '<th style="width: 60px;">No.</th>';
                columns.forEach(col => {
                    html += `<th>${col.title}</th>`;
                });
                html += '<th style="width: 100px;">Aksi</th>';
                html += '</tr></thead><tbody>';
                
                participants.forEach((participant, index) => {
                    html += '<tr>';
                    html += `<td style="text-align: center; font-weight: bold; color: #7f8c8d;">${index + 1}</td>`;
                    columns.forEach(col => {
                        let value = participant[col.field];
                        if (col.format) {
                            value = col.format(value);
                        }
                        html += `<td>${value || '-'}</td>`;
                    });
                    html += `<td><button class="btn btn-danger" onclick="removeParticipant(${participant.ikmBinaanId})" style="font-size: 12px; padding: 4px 8px;">Hapus</button></td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                document.getElementById('participants-table').innerHTML = html;
            } catch (error) {
                console.error('Failed to load participants:', error);
            }
        };

        // Add participant
        const addParticipant = async () => {
            const query = document.getElementById('search-participant').value.trim();
            if (!query) {
                showAlert('Masukkan NIB, NIK, atau nama untuk mencari peserta', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/api/pelatihan-pemberdayaan/${currentTrainingId}/peserta`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('Peserta berhasil ditambahkan', 'success');
                    document.getElementById('search-participant').value = '';
                    loadParticipants();
                    // Refresh training info
                    manageParticipants(currentTrainingId);
                } else {
                    showAlert(result.error || 'Gagal menambahkan peserta', 'error');
                }
            } catch (error) {
                console.error('Failed to add participant:', error);
                showAlert('Terjadi kesalahan saat menambahkan peserta', 'error');
            }
        };

        // Remove participant
        const removeParticipant = async (ikmBinaanId) => {
            if (confirm('Apakah Anda yakin ingin menghapus peserta ini dari pelatihan?')) {
                try {
                    const response = await fetch(`/api/pelatihan-pemberdayaan/${currentTrainingId}/peserta/${ikmBinaanId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        showAlert('Peserta berhasil dihapus', 'success');
                        loadParticipants();
                        // Refresh training info
                        manageParticipants(currentTrainingId);
                    } else {
                        const result = await response.json();
                        showAlert(result.error || 'Gagal menghapus peserta', 'error');
                    }
                } catch (error) {
                    console.error('Failed to remove participant:', error);
                    showAlert('Terjadi kesalahan saat menghapus peserta', 'error');
                }
            }
        };

        // Export participants
        const exportParticipants = (format) => {
            if (!currentTrainingId) return;
            
            const url = `/api/pelatihan-pemberdayaan/${currentTrainingId}/peserta/export/${format}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = `Peserta_Pelatihan_${currentTrainingId}_${new Date().toISOString().split('T')[0]}.${format === 'excel' ? 'xlsx' : 'pdf'}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // Hide participants modal
        const hideParticipantsModal = () => {
            document.getElementById('participants-modal').style.display = 'none';
            currentTrainingId = null;
        };

        // Handle search participant on Enter key
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('search-participant').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addParticipant();
                }
            });
        });

        // Show add form
        const showAddForm = () => {
            editingId = null;
            document.getElementById('form-title').textContent = 'Tambah Program Pelatihan';
            document.getElementById('pelatihan-form').reset();
            document.getElementById('form-modal').style.display = 'block';
        };

        // Edit pelatihan
        const editPelatihan = async (id) => {
            try {
                const pelatihan = await getDataById('pelatihan-pemberdayaan', id);
                editingId = id;
                document.getElementById('form-title').textContent = 'Edit Program Pelatihan';
                
                const form = document.getElementById('pelatihan-form');
                form.judulPelatihan.value = pelatihan.judulPelatihan || '';
                form.deskripsi.value = pelatihan.deskripsi || '';
                form.tanggalMulai.value = pelatihan.tanggalMulai || '';
                form.tanggalSelesai.value = pelatihan.tanggalSelesai || '';
                form.lokasi.value = pelatihan.lokasi || '';
                form.instruktur.value = pelatihan.instruktur || '';
                form.kuota.value = pelatihan.kuota || '';
                form.status.value = pelatihan.status || '';
                
                document.getElementById('form-modal').style.display = 'block';
            } catch (error) {
                console.error('Failed to load pelatihan data:', error);
            }
        };

        // Delete pelatihan
        const deletePelatihan = async (id) => {
            if (confirm('Apakah Anda yakin ingin menghapus program pelatihan ini? Data akan dipindahkan ke Recycle Bin.')) {
                try {
                    // Get the data first
                    const pelatihan = await getDataById('pelatihan-pemberdayaan', id);
                    
                    // Move to recycle bin
                    const recycleData = {
                        originalId: id,
                        dataType: 'pelatihan-pemberdayaan',
                        data: pelatihan,
                        deletedAt: new Date().toISOString(),
                        deletedBy: 'admin',
                        autoDeleteAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
                    };
                    
                    await createData('recycle-bin', recycleData);
                    
                    // Delete from main table
                    await deleteData('pelatihan-pemberdayaan', id);
                    
                    showAlert('Program pelatihan berhasil dihapus dan dipindahkan ke Recycle Bin', 'success');
                    loadPelatihan();
                } catch (error) {
                    console.error('Failed to delete pelatihan:', error);
                }
            }
        };

        // Hide form
        const hideForm = () => {
            document.getElementById('form-modal').style.display = 'none';
        };

        // Handle form submission
        document.getElementById('pelatihan-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Validate dates
            const startDate = new Date(data.tanggalMulai);
            const endDate = new Date(data.tanggalSelesai);
            
            if (endDate <= startDate) {
                showAlert('Tanggal selesai harus setelah tanggal mulai', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Menyimpan...';
            
            try {
                if (editingId) {
                    await updateData('pelatihan-pemberdayaan', editingId, data);
                    showAlert('Program pelatihan berhasil diperbarui', 'success');
                } else {
                    await createData('pelatihan-pemberdayaan', data);
                    showAlert('Program pelatihan berhasil ditambahkan', 'success');
                }
                
                hideForm();
                loadPelatihan();
            } catch (error) {
                console.error('Failed to save pelatihan data:', error);
                showAlert('Gagal menyimpan data', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Simpan';
            }
        });

        // Logout function
        const logout = () => {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                localStorage.removeItem('admin_user');
                window.location.href = 'login.html';
            }
        };

        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadPelatihan);
    </script>
</body>
</html>