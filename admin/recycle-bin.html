<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recycle Bin - Database IKM JUARA</title>
    <link rel="stylesheet" href="/shared/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .warning-banner {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .warning-banner i {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .auto-delete-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }
        
        .data-type-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: white;
        }
        
        .badge-ikm-binaan { background: #27ae60; }
        .badge-hki-merek { background: #3498db; }
        .badge-sertifikat-halal { background: #2ecc71; }
        .badge-tkdn-ik { background: #e74c3c; }
        .badge-siinas { background: #9b59b6; }
        .badge-uji-nilai-gizi { background: #f39c12; }
        .badge-kurasi-produk { background: #1abc9c; }
        .badge-pelatihan-pemberdayaan { background: #34495e; }
        
        .countdown {
            color: #e74c3c;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-industry" style="font-size: 24px;"></i>
            <h3 style="margin-top: 10px;">IKM JUARA</h3>
            <p style="font-size: 12px; margin-top: 5px;">DisnakerKUKM Kota Madiun</p>
        </div>
        
        <nav>
            <a href="index.html" class="menu-item">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </a>
            
            <a href="ikm-binaan.html" class="menu-item">
                <i class="fas fa-building"></i>
                IKM Binaan
            </a>
            
            <a href="inputan-layanan.html" class="menu-item">
                <i class="fas fa-plus-circle"></i>
                Inputan Layanan IKM
            </a>
            
            <a href="layanan-ikm.html" class="menu-item">
                <i class="fas fa-clipboard-list"></i>
                Layanan IKM Juara
            </a>
            
            <a href="pelatihan.html" class="menu-item">
                <i class="fas fa-graduation-cap"></i>
                Pelatihan Pemberdayaan
            </a>
            
            <a href="penelusuran.html" class="menu-item">
                <i class="fas fa-search"></i>
                Penelusuran Data
            </a>
            
            <a href="recycle-bin.html" class="menu-item active">
                <i class="fas fa-trash-restore"></i>
                Recycle Bin
            </a>
            
            <a href="/public" class="menu-item">
                <i class="fas fa-external-link-alt"></i>
                Website Publik
            </a>
            
            <a href="#" class="menu-item" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <h1>Recycle Bin</h1>
            <div class="user-info">
                <span id="user-name">Admin</span>
                <i class="fas fa-user-circle" style="margin-left: 10px; font-size: 24px;"></i>
            </div>
        </div>

        <!-- Warning Banner -->
        <div class="warning-banner">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Perhatian!</h3>
            <p>Data di Recycle Bin akan otomatis terhapus permanen setelah 7 hari. Pastikan untuk memulihkan data penting sebelum batas waktu habis.</p>
        </div>

        <!-- Auto Delete Info -->
        <div class="auto-delete-info">
            <i class="fas fa-info-circle"></i>
            <strong>Informasi:</strong> Data yang telah dihapus akan disimpan di Recycle Bin selama 7 hari. Setelah itu, data akan terhapus permanen dan tidak dapat dipulihkan.
        </div>

        <!-- Content -->
        <div class="table-container">
            <div class="table-header">
                <h3>Data yang Dihapus</h3>
                <div>
                    <button class="btn btn-warning" onclick="cleanupExpired()" style="margin-right: 10px;">
                        <i class="fas fa-broom"></i> Bersihkan Data Kadaluarsa
                    </button>
                    <button class="btn btn-danger" onclick="emptyRecycleBin()">
                        <i class="fas fa-trash"></i> Kosongkan Recycle Bin
                    </button>
                </div>
            </div>
            
            <div id="recycle-table">
                <!-- Table will be loaded here -->
            </div>
        </div>
    </div>

    <script src="/shared/script.js"></script>
    <script>
        // Check authentication
        const adminUser = localStorage.getItem('admin_user');
        if (!adminUser) {
            window.location.href = 'login.html';
        } else {
            const user = JSON.parse(adminUser);
            document.getElementById('user-name').textContent = user.nama;
        }

        // Load recycle bin data
        const loadRecycleBin = async () => {
            try {
                const data = await getData('recycle-bin');
                
                if (data.length === 0) {
                    document.getElementById('recycle-table').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                            <i class="fas fa-trash" style="font-size: 48px; margin-bottom: 20px; color: #bdc3c7;"></i>
                            <h3>Recycle Bin Kosong</h3>
                            <p>Tidak ada data yang dihapus saat ini.</p>
                        </div>
                    `;
                    return;
                }
                
                const columns = [
                    { 
                        field: 'dataType', 
                        title: 'Jenis Data',
                        format: (type) => {
                            const typeNames = {
                                'ikm-binaan': 'IKM Binaan',
                                'hki-merek': 'HKI Merek',
                                'sertifikat-halal': 'Sertifikat Halal',
                                'tkdn-ik': 'TKDN IK',
                                'siinas': 'SIINas',
                                'uji-nilai-gizi': 'Uji Nilai Gizi',
                                'kurasi-produk': 'Kurasi Produk',
                                'pelatihan-pemberdayaan': 'Pelatihan'
                            };
                            const name = typeNames[type] || type;
                            return `<span class="data-type-badge badge-${type}">${name}</span>`;
                        }
                    },
                    { 
                        field: 'data', 
                        title: 'Informasi Data',
                        format: (data, item) => {
                            let info = '';
                            if (data.namaLengkap) info += `<strong>${data.namaLengkap}</strong><br>`;
                            if (data.judulPelatihan) info += `<strong>${data.judulPelatihan}</strong><br>`;
                            if (data.nib) info += `NIB: ${data.nib}<br>`;
                            if (data.nik) info += `NIK: ${data.nik}<br>`;
                            if (data.namaUsaha) info += `Usaha: ${data.namaUsaha}`;
                            if (data.nomorPendaftaranHKI) info += `No. HKI: ${data.nomorPendaftaranHKI}`;
                            if (data.nomorSertifikatHalal) info += `No. Halal: ${data.nomorSertifikatHalal}`;
                            return info || 'Data tidak tersedia';
                        }
                    },
                    { 
                        field: 'deletedAt', 
                        title: 'Tanggal Dihapus',
                        format: (date) => new Date(date).toLocaleDateString('id-ID', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })
                    },
                    { field: 'deletedBy', title: 'Dihapus Oleh' },
                    { 
                        field: 'autoDeleteAt', 
                        title: 'Auto Delete',
                        format: (date) => {
                            const deleteDate = new Date(date);
                            const now = new Date();
                            const diffTime = deleteDate - now;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            
                            if (diffDays <= 0) {
                                return '<span class="countdown">Kadaluarsa</span>';
                            } else if (diffDays <= 2) {
                                return `<span class="countdown">${diffDays} hari lagi</span>`;
                            } else {
                                return `${diffDays} hari lagi`;
                            }
                        }
                    }
                ];
                
                const actions = [
                    { text: 'Pulihkan', class: 'success', onclick: 'restoreData' },
                    { text: 'Hapus Permanen', class: 'danger', onclick: 'permanentDelete' }
                ];
                
                document.getElementById('recycle-table').innerHTML = createTable(data, columns, actions);
            } catch (error) {
                console.error('Failed to load recycle bin data:', error);
            }
        };

        // Restore data
        const restoreData = async (id) => {
            if (confirm('Apakah Anda yakin ingin memulihkan data ini?')) {
                try {
                    const recycleItem = await getDataById('recycle-bin', id);
                    const { dataType, data: originalData } = recycleItem;
                    
                    // Remove recycle bin specific fields
                    delete originalData.id; // Let the API generate new ID
                    
                    // Restore to original table
                    await createData(dataType, originalData);
                    
                    // Remove from recycle bin
                    await deleteData('recycle-bin', id);
                    
                    showAlert('Data berhasil dipulihkan', 'success');
                    loadRecycleBin();
                } catch (error) {
                    console.error('Failed to restore data:', error);
                    showAlert('Gagal memulihkan data', 'error');
                }
            }
        };

        // Permanent delete
        const permanentDelete = async (id) => {
            if (confirm('PERINGATAN: Data akan dihapus permanen dan tidak dapat dipulihkan. Apakah Anda yakin?')) {
                try {
                    await deleteData('recycle-bin', id);
                    showAlert('Data berhasil dihapus permanen', 'success');
                    loadRecycleBin();
                } catch (error) {
                    console.error('Failed to permanently delete data:', error);
                    showAlert('Gagal menghapus data permanen', 'error');
                }
            }
        };

        // Cleanup expired data
        const cleanupExpired = async () => {
            if (confirm('Apakah Anda yakin ingin membersihkan semua data yang sudah kadaluarsa?')) {
                try {
                    const data = await getData('recycle-bin');
                    const now = new Date();
                    let deletedCount = 0;
                    
                    for (const item of data) {
                        const deleteDate = new Date(item.autoDeleteAt);
                        if (deleteDate <= now) {
                            await deleteData('recycle-bin', item.id);
                            deletedCount++;
                        }
                    }
                    
                    if (deletedCount > 0) {
                        showAlert(`${deletedCount} data kadaluarsa berhasil dibersihkan`, 'success');
                        loadRecycleBin();
                    } else {
                        showAlert('Tidak ada data kadaluarsa untuk dibersihkan', 'info');
                    }
                } catch (error) {
                    console.error('Failed to cleanup expired data:', error);
                    showAlert('Gagal membersihkan data kadaluarsa', 'error');
                }
            }
        };

        // Empty recycle bin
        const emptyRecycleBin = async () => {
            if (confirm('PERINGATAN: Semua data di Recycle Bin akan dihapus permanen dan tidak dapat dipulihkan. Apakah Anda yakin?')) {
                if (confirm('Konfirmasi sekali lagi: Semua data akan hilang permanen!')) {
                    try {
                        const data = await getData('recycle-bin');
                        let deletedCount = 0;
                        
                        for (const item of data) {
                            await deleteData('recycle-bin', item.id);
                            deletedCount++;
                        }
                        
                        showAlert(`${deletedCount} data berhasil dihapus permanen`, 'success');
                        loadRecycleBin();
                    } catch (error) {
                        console.error('Failed to empty recycle bin:', error);
                        showAlert('Gagal mengosongkan Recycle Bin', 'error');
                    }
                }
            }
        };

        // Logout function
        const logout = () => {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                localStorage.removeItem('admin_user');
                window.location.href = 'login.html';
            }
        };

        // Auto cleanup expired data on page load
        const autoCleanup = async () => {
            try {
                const data = await getData('recycle-bin');
                const now = new Date();
                
                for (const item of data) {
                    const deleteDate = new Date(item.autoDeleteAt);
                    if (deleteDate <= now) {
                        await deleteData('recycle-bin', item.id);
                    }
                }
            } catch (error) {
                console.error('Auto cleanup failed:', error);
            }
        };

        // Load data on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await autoCleanup();
            loadRecycleBin();
        });
    </script>
</body>
</html>